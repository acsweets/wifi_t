# 局域网双向通信项目 PRD

## 1. 项目概述

### 1.1 项目目标
在局域网环境下，实现两台设备（手机A/手机B）之间的双向数据传输，模拟智能眼镜↔手机的数据交互场景。

### 1.2 设备角色
- **手机A**：接收端（模拟眼镜）
- **手机B**：发送端（模拟手机）

## 2. 功能需求

### 2.1 设备发现
- 手动输入对方局域网IP
- 自动显示本机IP地址
- ✅ **mDNS自动发现设备**：自动搜索局域网内的WiFi-T设备

### 2.2 数据传输
- **图片传输**：选择图片 → 转Uint8List → WebSocket发送
- **文本消息**：输入文本 → JSON序列化 → 发送
- **双向通信**：接收端可以发送确认或简单消息回传
- **视频帧流传输**（模拟VR/投屏，后续扩展）

### 2.3 数据显示
- **图片**：实时显示接收到的图片
- **文本**：消息列表显示
- **双向消息**：区分发送/接收方向

### 2.4 UI设计
#### 发送端（手机B）：
- IP地址输入框 + 连接按钮
- 设备搜索按钮 + 发现设备列表
- 图片选择按钮
- 文本输入框 + 发送按钮
- 消息列表显示发送和接收内容

#### 接收端（手机A）：
- 本机IP显示 + 启动服务器按钮
- mDNS服务广播状态显示
- 接收图片显示区
- 接收文本消息显示列表
- 回复按钮

## 3. 技术选型

### 3.1 通信协议选择：WebSocket
**选择原因：**
- **实时性**：WebSocket提供全双工通信，延迟低
- **简单性**：相比TCP需要自定义协议，WebSocket有标准的帧格式
- **跨平台**：Flutter的web_socket_channel包支持良好
- **调试友好**：可以使用浏览器开发者工具调试

**vs TCP的对比：**
- TCP需要自定义消息边界和协议格式
- WebSocket已经处理了消息分帧和重连机制
- WebSocket更适合移动端开发

### 3.2 技术栈
- **框架**：Flutter 3.6+
- **通信**：WebSocket (web_socket_channel)
- **设备发现**：mDNS (multicast_dns)
- **图片选择**：image_picker
- **网络信息**：network_info_plus
- **权限管理**：permission_handler

## 4. 架构设计

### 4.1 项目结构
```
lib/
├── models/
│   └── message.dart          # 消息数据模型
├── services/
│   ├── websocket_service.dart # WebSocket通信服务
│   └── mdns_service.dart     # mDNS设备发现服务
├── screens/
│   ├── home_screen.dart      # 主界面（Tab切换）
│   ├── sender_screen.dart    # 发送端界面
│   └── receiver_screen.dart  # 接收端界面
└── main.dart                 # 应用入口
```

### 4.2 数据流
1. **连接建立**：接收端启动WebSocket服务器 → 发送端连接
2. **消息发送**：发送端创建Message对象 → JSON序列化 → WebSocket发送
3. **消息接收**：接收端监听WebSocket → JSON反序列化 → 更新UI
4. **双向通信**：接收端也可发送回复消息

## 5. 实现细节

### 5.1 消息格式
```dart
class Message {
  String id;              // 消息唯一标识
  MessageType type;       // 消息类型（text/image/video）
  String? text;           // 文本内容
  Uint8List? data;        // 二进制数据（图片/视频）
  String sender;          // 发送者标识
  DateTime timestamp;     // 时间戳
  bool isReceived;        // 是否为接收的消息
}
```

### 5.2 网络通信
- **端口**：8080（固定）
- **协议**：WebSocket over TCP
- **数据格式**：JSON
- **连接方式**：一对一连接

## 6. 使用流程

### 6.1 基本使用

#### 方式一：手动连接
1. 两台设备连接同一WiFi网络
2. 设备A打开"接收端"Tab，点击"启动服务器"，记录显示的IP地址
3. 设备B打开"发送端"Tab，输入设备A的IP地址，点击"连接"

#### 方式二：自动发现
1. 两台设备连接同一WiFi网络
2. 设备A打开"接收端"Tab，点击"启动服务器"（自动开始mDNS广播）
3. 设备B打开"发送端"Tab，点击"搜索设备"
4. 在发现的设备列表中点击相应设备的"连接"按钮

#### 通信测试
1. 连接成功后，设备B可发送文本和图片
2. 设备A可查看接收到的消息，并发送回复

### 6.2 功能测试
- 文本消息：输入文字 → 发送 → 对方接收显示
- 图片消息：选择图片 → 发送 → 对方接收显示
- 双向通信：接收方可回复消息

## 7. 后续扩展

### 7.1 功能扩展
- ✅ mDNS设备自动发现
- 视频流传输
- 文件传输
- 多设备连接
- 消息加密

### 7.2 性能优化
- 图片压缩
- 断线重连
- 消息缓存
- 网络状态监控